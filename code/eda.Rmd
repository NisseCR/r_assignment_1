---
title: "EDA"
author: "Aga, Karla, Nisse, Ole"
date: "`r Sys.Date()`"
output: html_document
---

# Bike sharing
## Load data
Data set is acquired from [machine-learning repo](https://archive.ics.uci.edu/dataset/275/bike+sharing+dataset).

Import the required dependencies.
```{r import, message = FALSE}
library(tidyverse)
library(fastDummies)
library(kableExtra)
```
Proceed to read the data.
```{r read bike}
source_data <- read.csv("../data/hour.csv", header = TRUE, sep = ",") %>%
    as_tibble()
```
Sub-select variables for linear model:
```{r select}
data <- select(source_data, dteday, hr, holiday, weathersit, temp, atemp, hum, windspeed, cnt)
```

## Preprocessing
### Missing data
Since all of our current predictor variables are numeric (rather than text), we  
can first find missing values by checking for the standard `NA` notation. In this  
case, we do *not* find any `NA` values.
```{r missing standard}
anyNA(data)
```
That said, missing values can still be represented as numeric values (e.g.  
`0`, `999`, `inf`). Therefore we check for non-standard formatted missing values by  
looking at the distributions of the predictor values.  
One thing worth noting, the `windspeed` distribution seems to have no lower values except for `0`. This raises
the question whether `0` is truly a value, or perhaps is a substitute for missing data.
```{r missing non-standard, message = FALSE}
# hr
ggplot(data, aes(x = hr)) + 
    geom_histogram(binwidth = 1)

# temp
ggplot(data, aes(x = temp)) + 
    geom_histogram()

# atemp
ggplot(data, aes(x = atemp)) + 
    geom_histogram()

# windspeed
ggplot(data, aes(x = windspeed)) + 
    geom_histogram()

# hum
ggplot(data, aes(x = hum)) + 
    geom_histogram()

# cnt
ggplot(data, aes(x = cnt)) + 
    geom_histogram()
```

### Factorise hour data
Since `hour` is categorical, we need to factorise the vector data. To do so, we need to determine representative segments of the day.
```{r determine segment}
# TODO create histogram hour ~ temp/cnt.

data$weathersit <- as.factor(data$weathersit)

w_df <- data

ggplot(w_df, aes(weathersit, cnt)) +
    geom_boxplot()
```


Based on earlier analysis, the following segments have been made for `hour` (**placeholder data**):  
* `[1..6]`
* `[7..12]`  
* `[13..18]`  
* `[19..24]`  
By using the `cut` function, we can create so-called bins for the `hour` data.  
The new index is saved in `hr_bin`.
```{r factorise hour}
# Increment the `hr` column by one for ease of indexing purposes
data$hr <- data$hr + 1

# Increment 24 hour to avoid splitting when grouping on data.
data$hr[data$hr == 24L] <- 1L

# Factorise the `hr` column using 4 categories / bins.
data <- data %>%
    mutate(hr_bin = cut(hr,
        breaks = c(0, 7, 15, 23),
        labels = NULL
    ))

# Print column transformation
head(select(data, hr, hr_bin), 30)
print(count(data, hr_bin))
```
After having created `hr_bin`, we aggregate the data based on both the date (`dteday`) and the hour segments (`hr_bin`). In case of dichotomous variables, we take the `mode` of the variable.
```{r aggregate hour}
# Create a `mode` function for aggregation.
mode <- function(x) {
    which.max(table(x))
}

# Aggregate over `hr_bin` factor.
data <- data %>%
    select(-hr) %>%
    group_by(dteday, hr_bin) %>%
    summarize(
        holiday = mode(holiday),
        temp = mean(temp),
        atemp = mean(atemp),
        windspeed = mean(atemp),
        weathersit = mode(weathersit),
        cnt = sum(cnt)
    )

head(data, 10)
```
Categorical variables (i.e. `hr_bin`) are not directly suited for regression analysis, unlike dichotomous or continous
variables. Instead, they need to be recoded into a series of variables which can then be entered into the regression
model [[UCLA](https://stats.oarc.ucla.edu/spss/faq/coding-systems-for-categorical-variables-in-regression-analysis-2/#)].
The chosen method is creating **dummy variables** for the categorical data, provided by the `dummy_cols` function.
By removing the first dummy variable we multi-collinearity issues in the model [[fastDummies documentation](https://cran.r-project.org/web/packages/fastDummies/fastDummies.pdf)].

(Further research: *generalised linear model*, using *poisson distribution.)

```{r dummy}
data <- dummy_cols(data, select_columns = c("hr_bin", "weathersit"), remove_first_dummy = TRUE)
head(data, 10)
```